import{ref as T,computed as F,watch as $,watchPostEffect as G}from"vue";import H from"fuse.js";function K(u){const h=new Set;for(const d of u)for(const c of d)h.add(c);return h}function k(u){if(!u||u.length===0)return new Set;const h=u.sort((c,S)=>c.size-S.size),d=new Set(h[0]);for(let c=1;c<h.length;c++){for(const S of d)h[c].has(S)||d.delete(S);if(d.size===0)break}return d}function O(u,h,d){if(!u||u.length===0)return d;const c=u.map(S=>{const z=S.children.map(b=>{const v=`${S.uid}:${b.uid}`;return h.get(v)||new Set});return S.match==="all"?k(z):K(z)});return k(c)}function Q(u,h){return!h||!Array.isArray(h)?[]:h.map(d=>{const c=new Set,S=d.getValue||(v=>v[d.uid]);u.forEach(v=>{const E=S(v);Array.isArray(E)?E.forEach(I=>I&&c.add(I)):E&&c.add(E)});const z=d.getLabel||(v=>v),b=[...c].map(v=>({uid:v,label:z(v),selected:!1}));return b.sort((v,E)=>String(v.label).localeCompare(String(E.label))),{...d,children:b}})}function ee(u,h={}){const{initialFacets:d,facetFields:c,initialSearchValue:S="",initialSortType:z="az",noDefaultSorts:b=!1,extraSortTypes:v={},searchOptions:E={},getSortValue:I=e=>e.title||e.label||"",countMode:q="none",urlSync:U}=h,B=e=>e.sort((t,a)=>{const n=I(t),s=I(a);return n&&s?String(n).localeCompare(String(s)):n?-1:s?1:0}),N={az:{text:"A-Z",sort:B},za:{text:"Z-A",sort:e=>B(e).reverse()}};function Z(e){return(e||[]).map(t=>({...t,open:t.open||!1,children:t.children.map(a=>({...a,selected:a.selected||!1})),selectedCount:0}))}const f=T([]),x=T(S),V=T(z),j=F(()=>!c||!u.value?.length?null:Q(u.value,c)),_=F(()=>({...b?{}:N,...v})),M=F(()=>{const e=new Map,t=y.value;if(!t||!c)return e;const a=new Map(c.map(n=>{const s=n.getValue||(o=>o[n.uid]);return[n.uid,s]}));for(let n=0;n<t.length;n++){const s=t[n];for(const o of c){const r=a.get(o.uid)(s),i=Array.isArray(r)?r:r?[r]:[];for(const m of i){const p=`${o.uid}:${m}`;e.has(p)||e.set(p,new Set),e.get(p).add(n)}}}return e}),D=F(()=>({shouldSort:!0,keys:["title","label","description","author"],...E})),y=F(()=>x.value?.length?new H(u.value,D.value).search(x.value).map(t=>t.item):u.value),A=F(()=>{const e=[];return f.value.forEach(t=>{const a=t.children.filter(n=>n.selected);a.length>0&&e.push({...t,children:a})}),e}),J=F(()=>{if(!A.value.length)return y.value;const e=M.value;if(e.size===0&&y.value.length>0&&c?.length>0)return[];const t=new Set(y.value.map((s,o)=>o)),a=O(A.value,e,t),n=[];for(const s of a)n.push(y.value[s]);return n}),P=F(()=>{const e=_.value[V.value]?.sort;return typeof e!="function"?J.value:e([...J.value])});function R(){f.value.forEach(e=>{e.children&&e.children.forEach(t=>t.selected=!1),e.selectedCount=0})}function L({groupUid:e,facetUid:t,selected:a}){const n=f.value.find(s=>s.uid===e);if(n){!n.multiple&&a&&n.children.forEach(o=>{o.uid!==t&&(o.selected=!1)});const s=n.children.find(o=>o.uid===t);s&&(s.selected=a),n.selectedCount=n.children.filter(o=>o.selected).length}}if($(j,e=>{const t=Z(d||e);t.forEach(a=>{a.selectedCount=a.children.filter(n=>n.selected).length}),f.value=t},{immediate:!0}),$([A,y],([e,t],[a,n])=>{if(!(q==="none"||!f.value.length)&&!(e===a&&t===n)){if(q==="simple"){const s=M.value;if(s.size===0&&y.value.length>0&&c?.length>0)return;const o=new Set(y.value.map((l,r)=>r));f.value.forEach(l=>{const r=e.filter(m=>m.uid!==l.uid),i=O(r,s,o);l.children.forEach(m=>{const p=`${l.uid}:${m.uid}`,g=s.get(p)||new Set,w=k([i,g]);m.count=w.size})})}else if(q==="intuitive"){const s=M.value;if(s.size===0&&y.value.length>0&&c?.length>0)return;const o=new Set(y.value.map((r,i)=>i)),l=O(e,s,o);f.value.forEach(r=>{r.children.forEach(i=>{const m=`${r.uid}:${i.uid}`,p=s.get(m)||new Set;if(i.selected)if(r.multiple){const g=k([l,p]);i.count=g.size}else i.count=l.size;else{const g=[];for(const C of e)g.push({...C,children:[...C.children]});let w=g.find(C=>C.uid===r.uid);w||(w={...r,children:[]},g.push(w)),r.multiple?w.children.push(i):w.children=[i];const W=O(g,s,o);i.count=W.size}})})}}},{deep:!0,immediate:!0}),U?.router&&U?.route){const{router:e,route:t}=U,a=()=>f.value&&f.value.length>0,n=()=>{if(!a())return;const l={...t.query};delete l.sort,delete l.search,f.value.forEach(r=>delete l[r.uid]),V.value&&V.value!==z&&(l.sort=V.value),x.value&&(l.search=x.value),A.value.forEach(r=>{r.children.length>0&&(l[r.uid]=r.children.map(i=>i.uid).join(","))}),JSON.stringify(l)!==JSON.stringify(t.query)&&e.push({query:l})},s=()=>{const l=t.query;l.sort&&(V.value=l.sort),l.search&&(x.value=l.search);const r=new Map;f.value.forEach(i=>{const m=l[i.uid]?l[i.uid].split(","):[];r.set(i.uid,new Set(m))}),f.value.forEach(i=>{const m=r.get(i.uid)||new Set;i.children.forEach(p=>{const g=p.selected,w=m.has(p.uid);g!==w&&L({groupUid:i.uid,facetUid:p.uid,selected:w})})})},o=G(()=>{f.value&&f.value.length>0&&(s(),o())});$([V,x,A],n,{deep:!0}),$(()=>t.query,s)}return{facets:f,searchValue:x,selectedSort:V,sortTypes:_,displayItems:P,selectedFacets:A,clearFilters:R,handleFacetChange:L}}export{ee as useFacets};
