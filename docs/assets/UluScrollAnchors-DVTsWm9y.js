import{onMounted as U,onUnmounted as _,watch as E,nextTick as x,ref as F,inject as p,computed as h,reactive as M,provide as y,createElementBlock as $,openBlock as B,renderSlot as P}from"vue";import{urlize as Y}from"@ulu/utils/string.js";import{getScrollParent as C}from"@ulu/utils/browser/dom.js";function D({sections:t,props:e,emit:a,componentElRef:u}){let n=null;function s(l){return t.value.findIndex(({element:v})=>l===v)}function o(l=null,v="down"){t.value.forEach(d=>{d!==l&&(d.active&&(d.inactiveFrom=v==="down"?"forward":"reverse",d.activeFrom=null),d.active=!1)})}function c(){let l=0,v=!0;const d=S=>{const{root:w}=n,A=w?w.scrollTop:document.documentElement.scrollTop||window.scrollY;if(e.debug&&(console.group("useScrollAnchors: onObserve"),console.log("Observer:",n),console.log("Last/Current Y:",`${l}/${A}`),console.log("Entries:",S.map(i=>({el:i.target,is:i.isIntersecting})))),v&&e.firstItemActive){e.debug&&console.log("Initial observation, respecting `firstItemActive`."),v=!1,l=A,e.debug&&console.groupEnd();return}v=!1;const f=A>l?"down":"up";l=A,e.debug&&console.log(`Scroll direction: ${f}`);const g=S.filter(i=>i.isIntersecting);if(e.debug&&console.log("Intersecting entries:",g.map(i=>i.target)),g.length>0){g.sort((m,O)=>s(m.target)-s(O.target));const i=f==="down"?g[g.length-1]:g[0];e.debug&&console.log("Chosen target entry:",i.target);const r=t.value[s(i.target)];r&&!r.active&&(e.debug&&console.log("Activating section:",r.title),x(()=>{o(r,f),r.active=!0,r.inactiveFrom=null,r.activeFrom=f==="down"?"forward":"reverse",a("section-change",{section:r,sections:t.value,active:!0})}))}else{e.debug&&console.log("No intersecting entries. Checking edge cases.");const i=t.value.find(r=>r.active);if(i){const r=S.find(m=>m.target===i.element);if(r&&!r.isIntersecting){const m=s(r.target),O=m===0,j=m===t.value.length-1;(O&&f==="up"&&!e.firstItemActive||j&&f==="down")&&(e.debug&&console.log("Deactivating section at edge:",i.title),x(()=>{o(null,f),a("section-change",{section:i,sections:t.value,active:!1})}))}}}e.debug&&console.groupEnd()};let b=null;e.observerOptions&&e.observerOptions.root?b=e.observerOptions.root:u.value&&(b=C(u.value),b===document.scrollingElement&&(b=null));const T={...e.observerOptions,root:b};n=new IntersectionObserver(d,T)}function I(){n&&(n.disconnect(),t.value.forEach(({element:l})=>{l&&n.observe(l)}))}function k(){n&&(n.disconnect(),n=null)}U(()=>{if(e.firstItemActive&&t.value.length>0){const l=t.value[0];l&&(l.active=!0)}c(),I()}),_(()=>{k()}),E(()=>t.value.length,()=>{x(()=>{I()})})}function V(t){const e=F(null),a=p("uluScrollAnchorsRegister"),u=p("uluScrollAnchorsUnregister"),n=c=>`ulu-sa-${Y(c)}`,s=h(()=>t.customTitleId||n(t.title)),o=M({id:Symbol("section-id"),title:t.title,titleId:s.value,element:null,active:!1,inactiveFrom:null,activeFrom:null});return E(()=>t.title,c=>{o.title=c,o.titleId=t.customTitleId||n(c)}),E(()=>t.customTitleId,c=>{o.titleId=c||n(t.title)}),U(()=>{a&&e.value&&(o.element=e.value,a(o))}),_(()=>{u&&u(o.id)}),{sectionRef:e,titleId:s,isActive:h(()=>o.active),inactiveFrom:h(()=>o.inactiveFrom),activeFrom:h(()=>o.activeFrom),section:o}}const L={__name:"UluScrollAnchors",props:{firstItemActive:Boolean,observerOptions:{type:Object,default:()=>({root:null,threshold:0,rootMargin:"-25% 0px -55% 0px"})},debug:Boolean},emits:["section-change"],setup(t,{emit:e}){const a=t,u=e,n=F([]),s=F(null);return D({sections:n,props:a,emit:u,componentElRef:s}),y("uluScrollAnchorsSections",h(()=>n.value)),y("uluScrollAnchorsRegister",o=>{n.value.push(o)}),y("uluScrollAnchorsUnregister",o=>{const c=n.value.findIndex(I=>I.id===o);c>-1&&n.value.splice(c,1)}),(o,c)=>(B(),$("div",{class:"scroll-anchors",ref_key:"componentEl",ref:s},[P(o.$slots,"default")],512))}};L.__docgenInfo={exportName:"default",displayName:"UluScrollAnchors",description:"",tags:{},props:[{name:"firstItemActive",description:"Make the first item active by default on load",type:{name:"boolean"}},{name:"observerOptions",description:`IntersectionObserver options
- Defaults: { root: null, threshold: 0, rootMargin: "-25% 0px -55% 0px" }
See: https://developer.mozilla.org/en-US/docs/Web/API/IntersectionObserver/IntersectionObserver`,type:{name:"object"},defaultValue:{func:!1,value:`{
  root: null,
  threshold: 0,
  rootMargin: "-25% 0px -55% 0px"
}`}},{name:"debug",description:"Enable debug logging for the IntersectionObserver",type:{name:"boolean"}}],events:[{name:"section-change"}],slots:[{name:"default"}],sourceFiles:["/Users/joescherben/Personal/Projects/ULU/frontend-vue/lib/components/systems/scroll-anchors/UluScrollAnchors.vue"]};export{L as _,V as u};
